<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Song Recommender</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;500;700&display=swap');

        body {
            font-family: 'Inter', sans-serif;
            background-color: #f3f4f6;
        }

        .spotify-link-disabled {
            color: #9ca3af;
            cursor: not-allowed;
            pointer-events: none;
        }

        #debug-output {
            background-color: #f0f4f8;
            border: 1px solid #cce0ff;
            color: #3b82f6;
            padding: 1rem;
            margin-top: 1rem;
            border-radius: 0.5rem;
            font-family: monospace;
            white-space: pre-wrap;
            word-wrap: break-word;
        }
    </style>
</head>

<body class="bg-gray-100 min-h-screen flex items-center justify-center p-4">

    <div class="bg-white p-8 rounded-xl shadow-lg w-full max-w-2xl">
        <div class="text-center mb-6">
            <h1 class="text-3xl font-bold text-gray-800">Song Recommender</h1>
            <p class="text-gray-600 mt-2">Find the perfect song for any mood, topic, or genre.</p>
        </div>

        <div class="flex flex-col md:flex-row space-y-4 md:space-y-0 md:space-x-4 mb-6">
            <input id="promptInput" type="text"
                class="flex-1 p-3 rounded-md border border-gray-300 focus:outline-none focus:ring-2 focus:ring-indigo-500 transition-all"
                placeholder="e.g., 'A song about anger and despair' or 'High-energy dance track'">
            <button id="recommendBtn"
                class="px-6 py-3 bg-indigo-600 text-white rounded-md font-semibold hover:bg-indigo-700 transition-colors shadow-md focus:outline-none focus:ring-2 focus:ring-indigo-500 focus:ring-offset-2">
                Get Recommendation
            </button>
        </div>

        <div id="loadingIndicator" class="hidden text-center text-indigo-600 mt-4">
            <div class="flex items-center justify-center">
                <svg class="animate-spin -ml-1 mr-3 h-5 w-5 text-indigo-600" xmlns="http://www.w3.org/2000/svg"
                    fill="none" viewBox="0 0 24 24">
                    <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                    <path class="opacity-75" fill="currentColor"
                        d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z">
                    </path>
                </svg>
                Processing your request...
            </div>
        </div>
        <div id="recommendationResult" class="hidden mt-6 bg-gray-50 p-6 rounded-lg border border-gray-200">
            <h2 class="text-xl font-semibold text-gray-800 mb-2">Recommended Song:</h2>
            <div id="songTitle" class="text-lg font-bold text-indigo-600"></div>
            <div id="songDescription" class="text-gray-700 mt-2"></div>
            <a id="songLink" href="#" target="_blank"
                class="inline-block mt-4 text-indigo-600 font-medium hover:text-indigo-800 transition-colors">Listen
                on Spotify</a>
        </div>
        <div id="previousRecommendations" class="mt-4 hidden">
            <h3 class="text-lg font-semibold text-gray-800 mb-2">Previous Recommendations:</h3>
            <div id="previousList" class="space-y-2"></div>
        </div>
        <div id="nextRecommendationBtn" class="hidden text-center mt-4">
            <button id="getAnotherBtn" class="px-6 py-3 bg-indigo-600 text-white rounded-md font-semibold hover:bg-indigo-700 transition-colors shadow-md focus:outline-none focus:ring-2 focus:ring-indigo-500 focus:ring-offset-2">
                Get Another Recommendation
            </button>
        </div>
        <div id="debug-output" class="hidden"></div>
        <div id="errorAlert" class="hidden mt-6 bg-red-100 p-4 rounded-lg border border-red-300 text-red-700">
            An error occurred while getting the recommendation. Please check the console for details.
        </div>
        <div id="messageBox" class="fixed inset-0 bg-gray-600 bg-opacity-50 flex items-center justify-center hidden">
            <div class="bg-white p-6 rounded-lg shadow-lg max-w-sm mx-auto text-center">
                <p id="messageContent" class="text-gray-800 mb-4"></p>
                <button id="closeMessageBtn" class="px-4 py-2 bg-indigo-600 text-white rounded-md">OK</button>
            </div>
        </div>
    </div>
    <script type="module">
        import {
            mySongData
        } from './my-songs.js';
        const spotifyClientId = '5f4eb9322cb444628fce7b5bbe3e40a0';
        const spotifyRedirectUri = 'https://joespi314.github.io/song-recommender';
        const googleApiKey = 'AIzaSyBgpL6IRplVSW_mummYo_yQ-G2CKeAliUM';
        const googleApiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-05-20:generateContent?key=${googleApiKey}`;

        function generateRandomString(length) {
            let text = '';
            let possible = 'ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789';
            for (let i = 0; i < length; i++) {
                text += possible.charAt(Math.floor(Math.random() * possible.length));
            }
            return text;
        }

        async function generateCodeChallenge(codeVerifier) {
            const digest = await crypto.subtle.digest('SHA-256', new TextEncoder().encode(codeVerifier));
            return btoa(String.fromCharCode(...new Uint8Array(digest)))
                .replace(/=/g, '')
                .replace(/\+/g, '-')
                .replace(/\//g, '_');
        }

        let spotifyAccessToken = null;

        async function handleSpotifyAuth() {
            debugOutput.innerHTML += `App started. Checking for Spotify access token...\n`;
            const urlParams = new URLSearchParams(window.location.search);
            let code = urlParams.get('code');
            if (code) {
                const codeVerifier = localStorage.getItem('spotify_code_verifier');
                localStorage.removeItem('spotify_code_verifier');

                if (!codeVerifier) {
                    showMessage("Authentication failed. Please try again.");
                    return;
                }

                try {
                    const response = await fetch('https://accounts.spotify.com/api/token', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/x-www-form-urlencoded;charset=UTF-8'
                        },
                        body: new URLSearchParams({
                            grant_type: 'authorization_code',
                            code: code,
                            redirect_uri: spotifyRedirectUri,
                            client_id: spotifyClientId,
                            code_verifier: codeVerifier,
                        }).toString()
                    });

                    if (!response.ok) {
                        const errorData = await response.json();
                        throw new Error(`Token exchange failed: ${JSON.stringify(errorData)}`);
                    }

                    const data = await response.json();
                    spotifyAccessToken = data.access_token;
                    localStorage.setItem('spotify_access_token', spotifyAccessToken);
                    showMessage('Spotify access granted! You can now get song recommendations with working links.');
                } catch (error) {
                    console.error('Spotify token exchange error:', error);
                    showMessage('Authentication failed. Check your console for details.');
                }
            } else {
                const codeVerifier = generateRandomString(128);
                const codeChallenge = await generateCodeChallenge(codeVerifier);
                localStorage.setItem('spotify_code_verifier', codeVerifier);

                const scope = 'user-read-private user-read-email';
                const authUrl = `https://accounts.spotify.com/authorize?response_type=code&client_id=${spotifyClientId}&scope=${encodeURIComponent(scope)}&redirect_uri=${encodeURIComponent(spotifyRedirectUri)}&code_challenge_method=S256&code_challenge=${codeChallenge}`;

                window.location.href = authUrl;
            }
        }

        window.onload = function() {
            spotifyAccessToken = localStorage.getItem('spotify_access_token');
            const urlParams = new URLSearchParams(window.location.search);
            let code = urlParams.get('code');

            if (code) {
                handleSpotifyAuth();
            } else if (spotifyAccessToken) {
                debugOutput.innerHTML += `App started. Spotify access token found.\n`;
            } else {
                debugOutput.innerHTML += `App started. No Spotify access token found. Await user action.\n`;
            }
        };

        const promptInput = document.getElementById('promptInput');
        const recommendBtn = document.getElementById('recommendBtn');
        const loadingIndicator = document.getElementById('loadingIndicator');
        const recommendationResult = document.getElementById('recommendationResult');
        const songTitle = document.getElementById('songTitle');
        const songDescription = document.getElementById('songDescription');
        const songLink = document.getElementById('songLink');
        const errorAlert = document.getElementById('errorAlert');
        const messageBox = document.getElementById('messageBox');
        const messageContent = document.getElementById('messageContent');
        const closeMessageBtn = document.getElementById('closeMessageBtn');
        const debugOutput = document.getElementById('debug-output');
        const getAnotherBtn = document.getElementById('getAnotherBtn');
        const nextRecommendationBtn = document.getElementById('nextRecommendationBtn');
        const previousRecommendations = document.getElementById('previousRecommendations');
        const previousList = document.getElementById('previousList');
        let chatHistory = [];

        function showMessage(message) {
            messageContent.textContent = message;
            messageBox.classList.remove('hidden');
        }

        closeMessageBtn.addEventListener('click', () => {
            messageBox.classList.add('hidden');
        });

        async function searchSpotify(query) {
            debugOutput.innerHTML += `Spotify search query: "${query}"\n`;

            if (!spotifyAccessToken) {
                return null;
            }

            try {
                const response = await fetch(`https://api.spotify.com/v1/search?q=${encodeURIComponent(query)}&type=track&limit=1`, {
                    headers: {
                        'Authorization': `Bearer ${spotifyAccessToken}`
                    }
                });

                if (response.status === 401) {
                    spotifyAccessToken = null;
                    localStorage.removeItem('spotify_access_token');
                    showMessage("Your Spotify session has expired. Please log in again.");
                    handleSpotifyAuth();
                    return null;
                }

                if (!response.ok) {
                    throw new Error(`Spotify API error: ${response.status} ${response.statusText}`);
                }

                const data = await response.json();
                const track = data.tracks.items[0];

                if (track) {
                    debugOutput.innerHTML += `Spotify Link Found: ${track.external_urls.spotify}\n`;
                    return track.external_urls.spotify;
                } else {
                    debugOutput.innerHTML += `No Spotify link found.\n`;
                    return null;
                }
            } catch (error) {
                console.error("Spotify API Search Error:", error);
                debugOutput.innerHTML += `Spotify API Search Error: ${error.message}\n`;
                return null;
            }
        }

        async function getRecommendation(excludedTitles = []) {
            loadingIndicator.classList.remove('hidden');
            recommendationResult.classList.add('hidden');
            errorAlert.classList.add('hidden');
            nextRecommendationBtn.classList.add('hidden');

            const prompt = promptInput.value.trim();

            debugOutput.classList.remove('hidden');
            debugOutput.innerHTML += `User input received: "${prompt}"\n`;
            debugOutput.innerHTML += `Starting recommendation process...\n`;

            if (prompt === "") {
                showMessage("Please enter a topic, mood, or genre to get a recommendation.");
                loadingIndicator.classList.add('hidden');
                return;
            }

            if (!spotifyAccessToken) {
                showMessage("To get a working Spotify link, please log in.");
                loadingIndicator.classList.add('hidden');
                handleSpotifyAuth();
                return;
            }

            const mySongDataString = JSON.stringify(mySongData);
            const systemPrompt = `You are a music recommendation AI. Your goal is to recommend a single song to the user based on their input.
            
            Here is a list of songs and albums you can recommend. You should prioritize songs from this list if they are a perfect match for the user's request. If no song from this list is a good fit, you may recommend a well-known, popular song from another artist that fits the request.

            Song Catalog:
            ${mySongDataString}

            Your response should be a concise, single paragraph. Include the song title and artist. If the song is from the provided catalog, also include a brief explanation of why you chose it, using details from the catalog. Do not use markdown formatting.

            Example output:
            "A perfect song for your request is 'Rise Above the Rage' by Joseph Schwartz. This song is a pre-election call for unity and a great fit for a message of hope."
            `;
            const userQuery = `Recommend a song based on this: "${prompt}"`;

            let recommendationText = '';
            let spotifyLink = null;

            try {
                const response = await fetch(googleApiUrl, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        contents: [{
                            parts: [{
                                text: userQuery
                            }]
                        }],
                        systemInstruction: {
                            parts: [{
                                text: systemPrompt
                            }]
                        }
                    })
                });

                if (!response.ok) {
                    throw new Error(`Google API error: ${response.status} ${response.statusText}`);
                }

                const result = await response.json();
                const candidate = result.candidates?.[0];

                if (candidate && candidate.content?.parts?.[0]?.text) {
                    recommendationText = candidate.content.parts[0].text;
                    debugOutput.innerHTML += `AI Raw Response: "${recommendationText}"\n`;

                    const match = recommendationText.match(/'([^']+)' by (.+)/);
                    if (match) {
                        const songName = match[1];
                        const artistName = match[2];

                        debugOutput.innerHTML += `Parsed Song Name: "${songName}"\n`;
                        debugOutput.innerHTML += `Parsed Artist Name: "${artistName}"\n`;

                        const foundSong = mySongData.find(song => song.title === songName && song.artist === artistName);

                        if (foundSong) {
                            debugOutput.innerHTML += `Found song in catalog. Artist ID: ${foundSong.artistId}\n`;
                            const spotifyQuery = `track:${encodeURIComponent(foundSong.title)} artist:${encodeURIComponent(foundSong.artistId)}`;
                            spotifyLink = await searchSpotify(spotifyQuery);
                        } else {
                            const spotifyQuery = `track:${encodeURIComponent(songName)} artist:${encodeURIComponent(artistName)}`;
                            spotifyLink = await searchSpotify(spotifyQuery);
                        }

                        songTitle.textContent = `"${songName}" by ${artistName}`;

                        let descriptionText = recommendationText.split('.').slice(1).join('.').trim();
                        songDescription.textContent = descriptionText || recommendationText;

                        if (spotifyLink) {
                            songLink.href = spotifyLink;
                            songLink.textContent = "Listen on Spotify";
                            songLink.classList.remove('spotify-link-disabled');
                        } else {
                            songLink.href = "javascript:void(0)";
                            songLink.textContent = "Link not found on Spotify.";
                            songLink.classList.add('spotify-link-disabled');
                        }

                        recommendationResult.classList.remove('hidden');
                        nextRecommendationBtn.classList.remove('hidden');
                    } else {
                        throw new Error('Could not parse song title and artist from AI response.');
                    }
                } else {
                    throw new Error('No recommendation found in the response.');
                }
            } catch (error) {
                console.error("Fetch error:", error);
                errorAlert.textContent = `An error occurred: ${error.message}`;
                errorAlert.classList.remove('hidden');
            } finally {
                loadingIndicator.classList.add('hidden');
            }
        }

        recommendBtn.addEventListener('click', async () => {
            debugOutput.innerHTML = `Beginning recommendation process...\n`;
            debugOutput.innerHTML += `Button pressed. Starting recommendation...\n`;
            await getRecommendation();
        });

        getAnotherBtn.addEventListener('click', async () => {
            const currentRec = {
                title: songTitle.textContent,
                description: songDescription.textContent
            };
            let existingRecs = JSON.parse(localStorage.getItem('previousRecs')) || [];
            existingRecs.push(currentRec);
            localStorage.setItem('previousRecs', JSON.stringify(existingRecs));

            previousList.innerHTML = '';
            existingRecs.forEach(rec => {
                const recDiv = document.createElement('div');
                recDiv.classList.add('p-3', 'bg-white', 'rounded-lg', 'shadow');
                recDiv.innerHTML = `<div class="font-bold text-gray-800">${rec.title}</div><div class="text-gray-600 mt-1">${rec.description}</div>`;
                previousList.appendChild(recDiv);
            });

            previousRecommendations.classList.remove('hidden');

            await getRecommendation();
        });

        promptInput.addEventListener('keypress', (event) => {
            if (event.key === 'Enter') {
                recommendBtn.click();
            }
        });

        
    </script>
</body>

</html>
