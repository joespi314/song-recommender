<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Song Recommender</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;500;700&display=swap');

        body {
            font-family: 'Inter', sans-serif;
            background-color: #f3f4f6;
        }

        .spotify-link-disabled {
            color: #9ca3af;
            cursor: not-allowed;
            pointer-events: none;
        }

        #debug-output {
            background-color: #f0f4f8;
            border: 1px solid #cce0ff;
            color: #3b82f6;
            padding: 1rem;
            margin-top: 1rem;
            border-radius: 0.5rem;
            font-family: monospace;
            white-space: pre-wrap;
            word-wrap: break-word;
        }
    </style>
</head>

<body class="bg-gray-100 min-h-screen flex items-center justify-center p-4">

    <div class="bg-white p-8 rounded-xl shadow-lg w-full max-w-2xl">
        <div class="text-center mb-6">
            <h1 class="text-3xl font-bold text-gray-800">Song Recommender</h1>
            <p class="text-gray-600 mt-2">Find the perfect song for any mood, topic, or genre.</p>
        </div>

        <div class="flex flex-col md:flex-row space-y-4 md:space-y-0 md:space-x-4 mb-6">
            <input id="promptInput" type="text"
                class="flex-1 p-3 rounded-md border border-gray-300 focus:outline-none focus:ring-2 focus:ring-indigo-500 transition-all"
                placeholder="e.g., 'A song about anger and despair' or 'High-energy dance track'">
            <button id="recommendBtn"
                class="px-6 py-3 bg-indigo-600 text-white rounded-md font-semibold hover:bg-indigo-700 transition-colors shadow-md focus:outline-none focus:ring-2 focus:ring-indigo-500 focus:ring-offset-2">
                Get Recommendation
            </button>
        </div>

        <div id="loadingIndicator" class="hidden text-center text-indigo-600 mt-4">
            <div class="flex items-center justify-center">
                <svg class="animate-spin -ml-1 mr-3 h-5 w-5 text-indigo-600" xmlns="http://www.w3.org/2000/svg"
                    fill="none" viewBox="0 0 24 24">
                    <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                    <path class="opacity-75" fill="currentColor"
                        d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z">
                    </path>
                </svg>
                Processing your request...
            </div>
        </div>

        <div id="recommendationResult" class="hidden mt-6 bg-gray-50 p-6 rounded-lg border border-gray-200">
            <h2 class="text-xl font-semibold text-gray-800 mb-2">Recommended Song:</h2>
            <div id="songTitle" class="text-lg font-bold text-indigo-600"></div>
            <div id="songDescription" class="text-gray-700 mt-2"></div>
            <a id="songLink" href="#" target="_blank"
                class="inline-block mt-4 text-indigo-600 font-medium hover:text-indigo-800 transition-colors">Listen
                on Spotify</a>
        </div>
        
        <div id="debug-output" class="hidden"></div>

        <div id="errorAlert" class="hidden mt-6 bg-red-100 p-4 rounded-lg border border-red-300 text-red-700">
            An error occurred while getting the recommendation. Please check the console for details.
        </div>

        <div id="messageBox" class="fixed inset-0 bg-gray-600 bg-opacity-50 flex items-center justify-center hidden">
            <div class="bg-white p-6 rounded-lg shadow-lg max-w-sm mx-auto text-center">
                <p id="messageContent" class="text-gray-800 mb-4"></p>
                <button id="closeMessageBtn" class="px-4 py-2 bg-indigo-600 text-white rounded-md">OK</button>
            </div>
        </div>
    </div>

    <script>
        // --- IMPORTANT: Replace these with your actual values from the Spotify dashboard ---
        // You MUST use the same Redirect URI in both the code and the Spotify dashboard.
        const spotifyClientId = '5f4eb9322cb444628fce7b5bbe3e40a0';
        const spotifyRedirectUri = 'https://joespi314.github.io/song-recommender';
        const googleApiKey = 'AIzaSyBgpL6IRplVSW_mummYo_yQ-G2CKeAliUM';
        const googleApiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-05-20:generateContent?key=${googleApiKey}`;


        // Helper functions for PKCE flow
        function generateRandomString(length) {
            let text = '';
            let possible = 'ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789';

            for (let i = 0; i < length; i++) {
                text += possible.charAt(Math.floor(Math.random() * possible.length));
            }
            return text;
        }

        async function generateCodeChallenge(codeVerifier) {
            const digest = await crypto.subtle.digest('SHA-256', new TextEncoder().encode(codeVerifier));
            return btoa(String.fromCharCode(...new Uint8Array(digest)))
                .replace(/=/g, '')
                .replace(/\+/g, '-')
                .replace(/\//g, '_');
        }

        // --- AUTHENTICATION FLOW ---
        let spotifyAccessToken = null;

        // Handles the PKCE authentication flow
        async function handleSpotifyAuth() {
            const urlParams = new URLSearchParams(window.location.search);
            let code = urlParams.get('code');

            // If we have a code, exchange it for an access token
            if (code) {
                const codeVerifier = localStorage.getItem('spotify_code_verifier');
                localStorage.removeItem('spotify_code_verifier');

                if (!codeVerifier) {
                    showMessage("Authentication failed. Please try again.");
                    return;
                }

                try {
                    const response = await fetch('https://accounts.spotify.com/api/token', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/x-www-form-urlencoded;charset=UTF-8'
                        },
                        body: new URLSearchParams({
                            grant_type: 'authorization_code',
                            code: code,
                            redirect_uri: spotifyRedirectUri,
                            client_id: spotifyClientId,
                            code_verifier: codeVerifier,
                        }).toString()
                    });

                    if (!response.ok) {
                        const errorData = await response.json();
                        throw new Error(`Token exchange failed: ${JSON.stringify(errorData)}`);
                    }

                    const data = await response.json();
                    spotifyAccessToken = data.access_token;
                    localStorage.setItem('spotify_access_token', spotifyAccessToken);
                    showMessage('Spotify access granted! You can now get song recommendations with working links.');
                } catch (error) {
                    console.error('Spotify token exchange error:', error);
                    showMessage('Authentication failed. Check your console for details.');
                }
            } else {
                // If no code, start the authentication process
                const codeVerifier = generateRandomString(128);
                const codeChallenge = await generateCodeChallenge(codeVerifier);

                localStorage.setItem('spotify_code_verifier', codeVerifier);

                const scope = 'user-read-private user-read-email';
                const authUrl = `https://accounts.spotify.com/authorize?response_type=code&client_id=${spotifyClientId}&scope=${encodeURIComponent(scope)}&redirect_uri=${encodeURIComponent(spotifyRedirectUri)}&code_challenge_method=S256&code_challenge=${codeChallenge}`;
                window.location.href = authUrl;
            }
        }

        // Check if an access token exists on load
        window.onload = function() {
            spotifyAccessToken = localStorage.getItem('spotify_access_token');
            const urlParams = new URLSearchParams(window.location.search);
            let code = urlParams.get('code');
            
            // If we have a code in the URL, finish the auth flow
            if (code) {
                handleSpotifyAuth();
            } else if (spotifyAccessToken) {
                // If a token exists in storage, we are already logged in
                console.log("Spotify token found in local storage.");
            }
        };

        // --- RECOMMENDATION LOGIC ---
        const promptInput = document.getElementById('promptInput');
        const recommendBtn = document.getElementById('recommendBtn');
        const loadingIndicator = document.getElementById('loadingIndicator');
        const recommendationResult = document.getElementById('recommendationResult');
        const songTitle = document.getElementById('songTitle');
        const songDescription = document.getElementById('songDescription');
        const songLink = document.getElementById('songLink');
        const errorAlert = document.getElementById('errorAlert');
        const messageBox = document.getElementById('messageBox');
        const messageContent = document.getElementById('messageContent');
        const closeMessageBtn = document.getElementById('closeMessageBtn');
        const debugOutput = document.getElementById('debug-output');

        // Your song catalog data in a structured format for easier access.
        const mySongData = [{
            title: "Modern Art",
            artist: "Joseph Schwartz",
            artistId: "1i0YtjdzwndXd3oQqiiLoT",
            releaseYear: "2025",
            description: "a collection of songs about the creator experience."
        }, {
            title: "Treadmill of hope",
            artist: "Joseph Schwartz",
            artistId: "1i0YtjdzwndXd3oQqiiLoT",
            releaseYear: "2025",
            description: "Pop with a rock edge, about the daily experiences of emerging artists and creators."
        }, {
            title: "Poison Darts",
            artist: "Joseph Schwartz",
            artistId: "1i0YtjdzwndXd3oQqiiLoT",
            releaseYear: "2025",
            description: "Focuses on random online negativity and chasing likes. Relatable to people on social media."
        }, {
            title: "What is art?",
            artist: "Joseph Schwartz",
            artistId: "1i0YtjdzwndXd3oQqiiLoT",
            releaseYear: "2025",
            description: "A reaction to anti-AI sentiment online, arguing that art should be judged on its own merits, not its creation method."
        }, {
            title: "Best of eight",
            artist: "Joseph Schwartz",
            artistId: "1i0YtjdzwndXd3oQqiiLoT",
            releaseYear: "2025",
            description: "Self-referential song about an AI-assisted creation process."
        }, {
            title: "Overnight success",
            artist: "Joseph Schwartz",
            artistId: "1i0YtjdzwndXd3oQqiiLoT",
            releaseYear: "2025",
            description: "Originally about the virtues of 'Patience + Righteousness,' now a song on the topic of patience and principles."
        }, {
            title: "No going back",
            artist: "Joseph Schwartz",
            artistId: "1i0YtjdzwndXd3oQqiiLoT",
            releaseYear: "2025",
            description: "Sane, practical view, about how evil needs misguided commitment, fear, lies, and greed."
        }, {
            title: "Gaslighting",
            artist: "Joseph Schwartz",
            artistId: "1i0YtjdzwndXd3oQqiiLoT",
            releaseYear: "2025",
            description: "Reflects anger and despair at political division, but with a hopeful tone."
        }, {
            title: "We're All Screwed",
            artist: "Joseph Schwartz",
            artistId: "1i0YtjdzwndXd3oQqiiLoT",
            releaseYear: "2025",
            description: "Expression of anger and despair at political division."
        }, {
            title: "Better Off",
            artist: "Joseph Schwartz",
            artistId: "1i0YtjdzwndXd3oQqiiLoT",
            releaseYear: "2025",
            description: "Satirical critique of Trump and Musk, exploring 'daddy issues.'"
        }, {
            title: "Rise Above the Rage",
            artist: "Joseph Schwartz",
            artistId: "1i0YtjdzwndXd3oQqiiLoT",
            releaseYear: "2024",
            description: "A pre-election call for unity."
        }, {
            title: "What Happened to Us?",
            artist: "Joseph Schwartz",
            artistId: "1i0YtjdzwndXd3oQqiiLoT",
            releaseYear: "2024",
            description: "A lament for broken relationships and societal divisions."
        }, {
            title: "Truth is Dead",
            artist: "Joseph Schwartz",
            artistId: "1i0YtjdzwndXd3oQqiiLoT",
            releaseYear: "2025",
            description: "Reflects disillusionment and the loss of truth."
        }, {
            title: "Screaming into the Abyss",
            artist: "Joseph Schwartz",
            artistId: "1i0YtjdzwndXd3oQqiiLoT",
            releaseYear: "2024",
            description: "Collection of political songs."
        }, {
            title: "Anger is all that matters",
            artist: "Joseph Schwartz",
            artistId: "1i0YtjdzwndXd3oQqiiLoT",
            releaseYear: "2024",
            description: "Two distinct voices about the self-destructive anger of the left and right."
        }, {
            title: "The Aftermath",
            artist: "Joseph Schwartz",
            artistId: "1i0YtjdzwndXd3oQqiiLoT",
            releaseYear: "2024",
            description: "Defiant anti-Trump song, reminiscent of Amy Lee."
        }, {
            title: "Pop Serenity Prayer",
            artist: "Joseph Schwartz",
            artistId: "1i0YtjdzwndXd3oQqiiLoT",
            releaseYear: "2024",
            description: "An inspiring pop interpretation of the Serenity Prayer."
        }, {
            title: "Battle against false prophets",
            artist: "Joseph Schwartz",
            artistId: "1i0YtjdzwndXd3oQqiiLoT",
            releaseYear: "2024",
            description: "Christian Rock song about fighting against Trump."
        }, {
            title: "The future",
            artist: "Joseph Schwartz",
            artistId: "1i0YtjdzwndXd3oQqiiLoT",
            releaseYear: "2024",
            description: "Pink Floyd/Alan Parsons feel, about the feelings people have about the future."
        }, {
            title: "The ballad of Donald",
            artist: "Joseph Schwartz",
            artistId: "1i0YtjdzwndXd3oQqiiLoT",
            releaseYear: "2024",
            description: "Traditional political folk song about Trump."
        }, {
            title: "J’adore manger a Gascogne",
            artist: "Joseph Schwartz",
            artistId: "1i0YtjdzwndXd3oQqiiLoT",
            releaseYear: "2025",
            description: "Happy, humorous song about food, inspired by a culinary tour in France."
        }, {
            title: "Searching for Purpose",
            artist: "Joseph Schwartz",
            artistId: "1i0YtjdzwndXd3oQqiiLoT",
            releaseYear: "2024",
            description: "Country song built from a single hook."
        }, {
            title: "Perspective",
            artist: "Joseph Schwartz",
            artistId: "1i0YtjdzwndXd3oQqiiLoT",
            releaseYear: "2024",
            description: "Pop Country, an uplifting song about overcoming fear."
        }, {
            title: "Songs That Need To Be Released",
            artist: "Joseph Schwartz",
            artistId: "1i0YtjdzwndXd3oQqiiLoT",
            releaseYear: "2025",
            description: "Wildly diverse songs."
        }, {
            title: "Ezekiel 23:20",
            artist: "Joseph Schwartz",
            artistId: "1i0YtjdzwndXd3oQqiiLoT",
            releaseYear: "2025",
            description: "A forceful response to book burning, quoting a biblical verse."
        }, {
            title: "Just Be Nice!",
            artist: "Joseph Schwartz",
            artistId: "1i0YtjdzwndXd3oQqiiLoT",
            releaseYear: "2025",
            description: "High-energy dance song with a forceful call for kindness."
        }, {
            title: "Changing my view",
            artist: "Joseph Schwartz",
            artistId: "1i0YtjdzwndXd3oQqiiLoT",
            releaseYear: "2025",
            description: "Song about an alternative perspective."
        }, {
            title: "The Raven",
            artist: "Joseph Schwartz",
            artistId: "1i0YtjdzwndXd3oQqiiLoT",
            releaseYear: "2025",
            description: "Alt-metal adaptation of Poe's poem."
        }, {
            title: "Humility",
            artist: "Joseph Schwartz",
            artistId: "1i0YtjdzwndXd3oQqiiLoT",
            releaseYear: "2025",
            description: "Explores the virtue of humility, aligned with Montaigne's writings."
        }, {
            title: "Perfect Being",
            artist: "Joseph Schwartz",
            artistId: "1i0YtjdzwndXd3oQqiiLoT",
            releaseYear: "2025",
            description: "Explores loneliness from a vampiress's perspective."
        }, {
            title: "No Win",
            artist: "Joseph Schwartz",
            artistId: "1i0YtjdzwndXd3oQqiiLoT",
            releaseYear: "2025",
            description: "Expresses the feeling of being trapped."
        }, {
            title: "Hold it back",
            artist: "Joseph Schwartz",
            artistId: "1i0YtjdzwndXd3oQqiiLoT",
            releaseYear: "2025",
            description: "Silly song."
        }, {
            title: "Caca vs. Me",
            artist: "Joseph Schwartz",
            artistId: "1i0YtjdzwndXd3oQqiiLoT",
            releaseYear: "2025",
            description: "Silly song about stomach issues on vacation."
        }, {
            title: "My Angel",
            artist: "Joseph Schwartz",
            artistId: "1i0YtjdzwndXd3oQqiiLoT",
            releaseYear: "2025",
            description: "Most streamed song, lyrics by Herman Bean."
        }, {
            title: "Beauty Queen",
            artist: "Joseph Schwartz",
            artistId: "1i0YtjdzwndXd3oQqiiLoT",
            releaseYear: "2025",
            description: "Beauty Queen (Country and Alternative versions)"
        }, {
            title: "Movin’ On",
            artist: "Joseph Schwartz",
            artistId: "1i0YtjdzwndXd3oQqiiLoT",
            releaseYear: "2025",
            description: "Movin’ On (Country and Rock versions)"
        }, {
            title: "Searching for a star",
            artist: "Joseph Schwartz",
            artistId: "1i0YtjdzwndXd3oQqiiLoT",
            releaseYear: "2025",
            description: "Searching for a star (Rock and Disco versions)"
        }, {
            title: "Herman Bean",
            artist: "Joseph Schwartz",
            artistId: "1i0YtjdzwndXd3oQqiiLoT",
            releaseYear: "2025",
            description: "Captures the story of the lyricist's sister."
        }, {
            title: "Through his eyes",
            artist: "Joseph Schwartz",
            artistId: "1i0YtjdzwndXd3oQqiiLoT",
            releaseYear: "2024",
            description: "The first full album of collaboration with lyricist Herman Bean"
        }, {
            title: "Keep on walking",
            artist: "Joseph Schwartz",
            artistId: "1i0YtjdzwndXd3oQqiiLoT",
            releaseYear: "2024",
            description: "The first full album of collaboration with lyricist Herman Bean"
        }, {
            title: "The time is coming",
            artist: "Joseph Schwartz",
            artistId: "1i0YtjdzwndXd3oQqiiLoT",
            releaseYear: "2024",
            description: "The first full album of collaboration with lyricist Herman Bean"
        }, {
            title: "Child grows",
            artist: "Joseph Schwartz",
            artistId: "1i0YtjdzwndXd3oQqiiLoT",
            releaseYear: "2024",
            description: "The first full album of collaboration with lyricist Herman Bean"
        }, {
            title: "Summertime",
            artist: "Joseph Schwartz",
            artistId: "1i0YtjdzwndXd3oQqiiLoT",
            releaseYear: "2024",
            description: "The first full album of collaboration with lyricist Herman Bean"
        }, {
            title: "Win or lose",
            artist: "Joseph Schwartz",
            artistId: "1i0YtjdzwndXd3oQqiiLoT",
            releaseYear: "2024",
            description: "The first full album of collaboration with lyricist Herman Bean"
        }, {
            title: "That's the way it should be",
            artist: "Joseph Schwartz",
            artistId: "1i0YtjdzwndXd3oQqiiLoT",
            releaseYear: "2024",
            description: "The first full album of collaboration with lyricist Herman Bean"
        }, {
            title: "I'll see you in the heavens tonight",
            artist: "Joseph Schwartz",
            artistId: "1i0YtjdzwndXd3oQqiiLoT",
            releaseYear: "2024",
            description: "The first full album of collaboration with lyricist Herman Bean"
        }, {
            title: "Fighter!",
            artist: "Joseph Schwartz",
            artistId: "1i0YtjdzwndXd3oQqiiLoT",
            releaseYear: "2024",
            description: "The first full album of collaboration with lyricist Herman Bean"
        }, {
            title: "Wings of Faith",
            artist: "Joseph Schwartz",
            artistId: "1i0YtjdzwndXd3oQqiiLoT",
            releaseYear: "2024",
            description: "Captures the essence of a quote by Steven Weinberg about faith."
        }, {
            title: "Kindness",
            artist: "Joseph Schwartz",
            artistId: "1i0YtjdzwndXd3oQqiiLoT",
            releaseYear: "2024",
            description: "Storytelling singer-songwriter song about the personal benefits of kindness."
        }, {
            title: "Dance Like the Man",
            artist: "Joseph Schwartz",
            artistId: "1i0YtjdzwndXd3oQqiiLoT",
            releaseYear: "2024",
            description: "all versions: A single song with different genre arrangements (Americana, Pop Country, Deep House) with lyrics as a rant about Trump sycophants."
        }, {
            title: "Sloth",
            artist: "Joseph Schwartz",
            artistId: "1i0YtjdzwndXd3oQqiiLoT",
            releaseYear: "2024",
            description: "REM-like jangle pop."
        }, {
            title: "Pride",
            artist: "Joseph Schwartz",
            artistId: "1i0YtjdzwndXd3oQqiiLoT",
            releaseYear: "2024",
            description: "Power pop/rock."
        }, {
            title: "Greed",
            artist: "Joseph Schwartz",
            artistId: "1i0YtjdzwndXd3oQqiiLoT",
            releaseYear: "2024",
            description: "Alt-rock."
        }, {
            title: "Lust",
            artist: "Joseph Schwartz",
            artistId: "1i0YtjdzwndXd3oQqiiLoT",
            releaseYear: "2024",
            description: "Lust, Vanity, Gluttony, Wrath."
        }, {
            title: "Vanity",
            artist: "Joseph Schwartz",
            artistId: "1i0YtjdzwndXd3oQqiiLoT",
            releaseYear: "2024",
            description: "Lust, Vanity, Gluttony, Wrath."
        }, {
            title: "Gluttony",
            artist: "Joseph Schwartz",
            artistId: "1i0YtjdzwndXd3oQqiiLoT",
            releaseYear: "2024",
            description: "Lust, Vanity, Gluttony, Wrath."
        }, {
            title: "Wrath",
            artist: "Joseph Schwartz",
            artistId: "1i0YtjdzwndXd3oQqiiLoT",
            releaseYear: "2024",
            description: "Lust, Vanity, Gluttony, Wrath."
        }, {
            title: "Tangled Words",
            artist: "Joseph Schwartz",
            artistId: "1i0YtjdzwndXd3oQqiiLoT",
            releaseYear: "2024",
            description: "Critiques the language of the Second Amendment."
        }, {
            title: "The Hardest Truth of All",
            artist: "Joseph Schwartz",
            artistId: "1i0YtjdzwndXd3oQqiiLoT",
            releaseYear: "2024",
            description: "Captures the feeling of a MAGA supporter being misled."
        }, {
            title: "Woken from a Lie",
            artist: "Joseph Schwartz",
            artistId: "1i0YtjdzwndXd3oQqiiLoT",
            releaseYear: "2025",
            description: "Similar to 'The Hardest Truth of All.'"
        }, {
            title: "Herman Bean Country and Variants",
            artist: "Joseph Schwartz",
            artistId: "1i0YtjdzwndXd3oQqiiLoT",
            releaseYear: "2024",
            description: "Showcases the versatility of Herman Bean's lyrics by presenting different musical interpretations of the same lyrics."
        }, {
            title: "My Angel (Country Version)",
            artist: "Joseph Schwartz",
            artistId: "1i0YtjdzwndXd3oQqiiLoT",
            releaseYear: "2024",
            description: "My Angel (Country Version)"
        }, {
            title: "My Angel (Pop Version)",
            artist: "Joseph Schwartz",
            artistId: "1i0YtjdzwndXd3oQqiiLoT",
            releaseYear: "2024",
            description: "My Angel (Pop Version)"
        }, {
            title: "Beauty Queen (Country Version)",
            artist: "Joseph Schwartz",
            artistId: "1i0YtjdzwndXd3oQqiiLoT",
            releaseYear: "2024",
            description: "Beauty Queen (Country Version)"
        }, {
            title: "Beauty Queen (Alternative Version)",
            artist: "Joseph Schwartz",
            artistId: "1i0YtjdzwndXd3oQqiiLoT",
            releaseYear: "2024",
            description: "Beauty Queen (Alternative Version)"
        }, {
            title: "Movin’ On (Country Version)",
            artist: "Joseph Schwartz",
            artistId: "1i0YtjdzwndXd3oQqiiLoT",
            releaseYear: "2024",
            description: "Movin’ On (Country and Rock versions)"
        }, {
            title: "Movin’ On (Rock Version)",
            artist: "Joseph Schwartz",
            artistId: "1i0YtjdzwndXd3oQqiiLoT",
            releaseYear: "2024",
            description: "Movin’ On (Rock Version)"
        }, {
            title: "Searching for a star (Rock Version)",
            artist: "Joseph Schwartz",
            artistId: "1i0YtjdzwndXd3oQqiiLoT",
            releaseYear: "2024",
            description: "Searching for a star (Rock Version)"
        }, {
            title: "Searching for a star (Disco Version)",
            artist: "Joseph Schwartz",
            artistId: "1i0YtjdzwndXd3oQqiiLoT",
            releaseYear: "2024",
            description: "Searching for a star (Disco Version)"
        }, {
            title: "Relax",
            artist: "Icebox Pi",
            artistId: "4lwHc4bYmRIJcaTOLqFxBy",
            releaseYear: "2024",
            description: "An ambient drone album that feels like a float around the universe."
        }, {
            title: "Cosmic Window Shopping",
            artist: "Icebox Pi",
            artistId: "4lwHc4bYmRIJcaTOLqFxBy",
            releaseYear: "2024",
            description: "An ambient drone album that feels like a float around the universe."
        }, {
            title: "Peaceful Journey",
            artist: "Icebox Pi",
            artistId: "4lwHc4bYmRIJcaTOLqFxBy",
            releaseYear: "2024",
            description: "A new-age album."
        }];

        // This function finds the song data, including the release year and artist ID, from the catalog.
        function findSongData(songTitleFromAI, artistFromAI) {
            const cleanedTitle = songTitleFromAI.replace(/['"]/g, '').trim();
            const cleanedArtist = artistFromAI.replace(/['"]/g, '').trim();
            
            // First, try to find a perfect match including the artist name
            const perfectMatch = mySongData.find(song => song.title.toLowerCase() === cleanedTitle.toLowerCase() && song.artist.toLowerCase() === cleanedArtist.toLowerCase());
            if (perfectMatch) {
                return perfectMatch;
            }
            
            // If no perfect match, just try matching the title (for flexibility)
            return mySongData.find(song => song.title.toLowerCase() === cleanedTitle.toLowerCase());
        }

        async function searchSpotify(query) {
            if (!spotifyAccessToken) {
                return null;
            }

            try {
                const searchUrl = `https://api.spotify.com/v1/search?q=${encodeURIComponent(query)}&type=track&limit=1`;
                
                const response = await fetch(searchUrl, {
                    headers: {
                        'Authorization': `Bearer ${spotifyAccessToken}`
                    }
                });

                if (response.status === 401) {
                    // Token expired, clear storage and show message
                    localStorage.removeItem('spotify_access_token');
                    showMessage("Your Spotify session has expired. Please log in again.");
                    return null;
                }

                if (!response.ok) {
                    throw new Error(`Spotify API error: ${response.status} ${response.statusText}`);
                }

                const data = await response.json();
                const track = data.tracks.items[0];

                if (track) {
                    return track.external_urls.spotify;
                } else {
                    return null;
                }
            } catch (error) {
                console.error("Spotify API Search Error:", error);
                return null;
            }
        }

        async function searchSpotifyById(query, artistId) {
            if (!spotifyAccessToken || !artistId || artistId.startsWith('placeholder')) {
                // Fallback if artistId is not available or is a placeholder
                return searchSpotify(query);
            }

            try {
                const searchUrl = `https://api.spotify.com/v1/search?q=track:${encodeURIComponent(query)}%20artist:${encodeURIComponent(artistId)}&type=track&limit=1`;
                
                const response = await fetch(searchUrl, {
                    headers: {
                        'Authorization': `Bearer ${spotifyAccessToken}`
                    }
                });

                if (response.status === 401) {
                    localStorage.removeItem('spotify_access_token');
                    showMessage("Your Spotify session has expired. Please log in again.");
                    return null;
                }

                if (!response.ok) {
                    throw new Error(`Spotify API error: ${response.status} ${response.statusText}`);
                }

                const data = await response.json();
                const track = data.tracks.items[0];
                
                if (track) {
                    return track.external_urls.spotify;
                } else {
                    return null;
                }
            } catch (error) {
                console.error("Spotify API Search Error:", error);
                return null;
            }
        }

        recommendBtn.addEventListener('click', async () => {
            const prompt = promptInput.value.trim();
            if (prompt === "") {
                showMessage("Please enter a topic, mood, or genre to get a recommendation.");
                return;
            }
            
            // Check if we have an access token, otherwise start the auth flow
            if (!spotifyAccessToken) {
                showMessage("To get a working Spotify link, you need to log in. Please click OK to continue.");
                closeMessageBtn.onclick = () => {
                    messageBox.classList.add('hidden');
                    handleSpotifyAuth();
                };
                return;
            }
            
            loadingIndicator.classList.remove('hidden');
            recommendationResult.classList.add('hidden');
            errorAlert.classList.add('hidden');
            recommendBtn.disabled = true;
            debugOutput.classList.remove('hidden');
            debugOutput.textContent = "Beginning recommendation process...\n";

            const systemPrompt = `You are a music recommendation AI. Your goal is to recommend a single song to the user based on their input.

            Prioritize finding a song that is a perfect match from the following catalog. If no song from the catalog is a good fit, you may recommend a well-known, popular song from another artist that fits the request.

            The music catalog is as follows:
            ${mySongData.map(s => `${s.title} by ${s.artist} (Released ${s.releaseYear}): ${s.description}`).join('\n')}

            Your response should be a concise, single paragraph. Do not mention that you are using a provided catalog. Include the song title and artist. If the song is from the provided catalog, also include a brief explanation of why you chose it. Do not use any markdown formatting.

            Example output:
            "A perfect song for your request is 'Rise Above the Rage' by Joseph Schwartz. This song is a pre-election call for unity and a great fit for a message of hope."
            `;

            const userQuery = `Recommend a song based on this: "${prompt}"`;
            debugOutput.textContent += `User Query to AI: "${userQuery}"\n`;

            let recommendationText = '';
            let spotifyLink = null;

            try {
                const response = await fetch(googleApiUrl, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        contents: [{
                            parts: [{
                                text: userQuery
                            }]
                        }],
                        systemInstruction: {
                            parts: [{
                                text: systemPrompt
                            }]
                        }
                    })
                });

                if (!response.ok) {
                    throw new Error(`Google API error: ${response.status} ${response.statusText}`);
                }

                const result = await response.json();
                const candidate = result.candidates?.[0];

                if (candidate && candidate.content?.parts?.[0]?.text) {
                    recommendationText = candidate.content.parts[0].text;
                    debugOutput.textContent += `AI Raw Response: "${recommendationText}"\n`;
                    
                    const firstSentenceEndIndex = recommendationText.indexOf('.');
                    const firstSentence = recommendationText.substring(0, firstSentenceEndIndex + 1);
                    const description = recommendationText.substring(firstSentenceEndIndex + 1).trim();
                    
                    const match = firstSentence.match(/'([^']+)' by ([^.]+)/);

                    if (match && match[1] && match[2]) {
                        const songName = match[1];
                        const artistName = match[2];
                        const cleanDescription = description.replace(/^A perfect song for your request is '.*?' by .*?\. /, '').trim();

                        songTitle.textContent = `"${songName}" by ${artistName}`;
                        songDescription.textContent = cleanDescription;
                        
                        debugOutput.textContent += `Parsed Song Name: "${songName}"\n`;
                        debugOutput.textContent += `Parsed Artist Name: "${artistName}"\n`;
                        
                        const songData = mySongData.find(song => song.title.toLowerCase() === songName.toLowerCase() && song.artist.toLowerCase() === artistName.toLowerCase());
                        
                        if (songData) {
                             debugOutput.textContent += `Found song in catalog. Artist ID: ${songData.artistId}\n`;
                            spotifyLink = await searchSpotifyById(songData.title, songData.artistId);
                        } else {
                             debugOutput.textContent += `Song not in catalog. Performing general search.\n`;
                            spotifyLink = await searchSpotify(`${songName} by ${artistName}`);
                        }
                        
                        if (spotifyLink) {
                            songLink.href = spotifyLink;
                            songLink.textContent = "Listen on Spotify";
                            songLink.classList.remove('spotify-link-disabled');
                            debugOutput.textContent += `Spotify Link Found: ${spotifyLink}\n`;
                        } else {
                            songLink.href = "javascript:void(0)";
                            songLink.textContent = "Link not found on Spotify.";
                            songLink.classList.add('spotify-link-disabled');
                            debugOutput.textContent += `No Spotify link found.\n`;
                        }
                    } else {
                        throw new Error('Could not parse song title and artist from AI response.');
                    }

                    recommendationResult.classList.remove('hidden');
                } else {
                    throw new Error('No recommendation found in the response.');
                }
            } catch (error) {
                console.error("Fetch error:", error);
                errorAlert.textContent = `An error occurred: ${error.message}`;
                errorAlert.classList.remove('hidden');
            } finally {
                loadingIndicator.classList.add('hidden');
                recommendBtn.disabled = false;
            }
        });

        // Event listener for the Enter key on the input field
        promptInput.addEventListener('keypress', (event) => {
            if (event.key === 'Enter') {
                recommendBtn.click();
            }
        });

        function showMessage(message) {
            messageContent.textContent = message;
            messageBox.classList.remove('hidden');
        }

        closeMessageBtn.addEventListener('click', () => {
            messageBox.classList.add('hidden');
        });
    </script>
</body>

</html>
