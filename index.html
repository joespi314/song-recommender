<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Song Recommender</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;500;700&display=swap');

        body {
            font-family: 'Inter', sans-serif;
            background-color: #f3f4f6;
        }

        .spotify-link-disabled {
            color: #9ca3af;
            cursor: not-allowed;
            pointer-events: none;
        }

        #debug-output {
            background-color: #f0f4f8;
            border: 1px solid #cce0ff;
            color: #3b82f6;
            padding: 1rem;
            margin-top: 1rem;
            border-radius: 0.5rem;
            font-family: monospace;
            white-space: pre-wrap;
            word-wrap: break-word;
        }
    </style>
</head>

<body class="bg-gray-100 min-h-screen flex items-center justify-center p-4">

    <div class="bg-white p-8 rounded-xl shadow-lg w-full max-w-2xl">
        <div class="text-center mb-6">
            <h1 class="text-3xl font-bold text-gray-800">Song Recommender</h1>
            <p class="text-gray-600 mt-2">Find the perfect song for any mood, topic, or genre.</p>
        </div>

        <div class="flex flex-col md:flex-row space-y-4 md:space-y-0 md:space-x-4 mb-6">
            <input id="promptInput" type="text"
                class="flex-1 p-3 rounded-md border border-gray-300 focus:outline-none focus:ring-2 focus:ring-indigo-500 transition-all"
                placeholder="e.g., 'A song about anger and despair' or 'High-energy dance track'">
            <button id="recommendBtn"
                class="px-6 py-3 bg-indigo-600 text-white rounded-md font-semibold hover:bg-indigo-700 transition-colors shadow-md focus:outline-none focus:ring-2 focus:ring-indigo-500 focus:ring-offset-2">
                Get Recommendation
            </button>
        </div>

        <div id="loadingIndicator" class="hidden text-center text-indigo-600 mt-4">
            <div class="flex items-center justify-center">
                <svg class="animate-spin -ml-1 mr-3 h-5 w-5 text-indigo-600" xmlns="http://www.w3.org/2000/svg"
                    fill="none" viewBox="0 0 24 24">
                    <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                    <path class="opacity-75" fill="currentColor"
                        d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z">
                    </path>
                </svg>
                Processing your request...
            </div>
        </div>
        <div id="recommendationResult" class="hidden mt-6 bg-gray-50 p-6 rounded-lg border border-gray-200">
            <h2 class="text-xl font-semibold text-gray-800 mb-2">Recommended Song:</h2>
            <div id="songTitle" class="text-lg font-bold text-indigo-600"></div>
            <div id="songDescription" class="text-gray-700 mt-2"></div>
            <a id="songLink" href="#" target="_blank"
                class="inline-block mt-4 text-indigo-600 font-medium hover:text-indigo-800 transition-colors">Listen
                on Spotify</a>
        </div>
        <div id="previousRecommendations" class="mt-4 hidden">
            <h3 class="text-lg font-semibold text-gray-800 mb-2">Previous Recommendations:</h3>
            <div id="previousList" class="space-y-2"></div>
        </div>
        <div id="nextRecommendationBtn" class="hidden text-center mt-4">
            <button id="getAnotherBtn" class="px-6 py-3 bg-indigo-600 text-white rounded-md font-semibold hover:bg-indigo-700 transition-colors shadow-md focus:outline-none focus:ring-2 focus:ring-indigo-500 focus:ring-offset-2">
                Get Another Recommendation
            </button>
        </div>
        <div id="debug-output" class="hidden"></div>
        <div id="errorAlert" class="hidden mt-6 bg-red-100 p-4 rounded-lg border border-red-300 text-red-700">
            An error occurred while getting the recommendation. Please check the console for details.
        </div>
        <div id="messageBox" class="fixed inset-0 bg-gray-600 bg-opacity-50 flex items-center justify-center hidden">
            <div class="bg-white p-6 rounded-lg shadow-lg max-w-sm mx-auto text-center">
                <p id="messageContent" class="text-gray-800 mb-4"></p>
                <button id="closeMessageBtn" class="px-4 py-2 bg-indigo-600 text-white rounded-md">OK</button>
            </div>
        </div>
    </div>
    <script>
        const spotifyClientId = '5f4eb9322cb444628fce7b5bbe3e40a0';
        const spotifyRedirectUri = 'https://joespi314.github.io/song-recommender';
        const googleApiKey = 'AIzaSyBgpL6IRplVSW_mummYo_yQ-G2CKeAliUM';
        const googleApiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-05-20:generateContent?key=${googleApiKey}`;
        function generateRandomString(length) {
            let text = '';
            let possible = 'ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789';
            for (let i = 0; i < length; i++) {
                text += possible.charAt(Math.floor(Math.random() * possible.length));
            }
            return text;
        }
        async function generateCodeChallenge(codeVerifier) {
            const digest = await crypto.subtle.digest('SHA-256', new TextEncoder().encode(codeVerifier));
            return btoa(String.fromCharCode(...new Uint8Array(digest)))
                .replace(/=/g, '')
                .replace(/\+/g, '-')
                .replace(/\//g, '_');
        }
        let spotifyAccessToken = null;
        async function handleSpotifyAuth() {
            const urlParams = new URLSearchParams(window.location.search);
            let code = urlParams.get('code');
            if (code) {
                const codeVerifier = localStorage.getItem('spotify_code_verifier');
                localStorage.removeItem('spotify_code_verifier');
                if (!codeVerifier) {
                    showMessage("Authentication failed. Please try again.");
                    return;
                }
                try {
                    const response = await fetch('https://accounts.spotify.com/api/token', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/x-www-form-urlencoded;charset=UTF-8'
                        },
                        body: new URLSearchParams({
                            grant_type: 'authorization_code',
                            code: code,
                            redirect_uri: spotifyRedirectUri,
                            client_id: spotifyClientId,
                            code_verifier: codeVerifier,
                        }).toString()
                    });
                    if (!response.ok) {
                        const errorData = await response.json();
                        throw new Error(`Token exchange failed: ${JSON.stringify(errorData)}`);
                    }
                    const data = await response.json();
                    spotifyAccessToken = data.access_token;
                    localStorage.setItem('spotify_access_token', spotifyAccessToken);
                    showMessage('Spotify access granted! You can now get song recommendations with working links.');
                } catch (error) {
                    console.error('Spotify token exchange error:', error);
                    showMessage('Authentication failed. Check your console for details.');
                }
            } else {
                const codeVerifier = generateRandomString(128);
                const codeChallenge = await generateCodeChallenge(codeVerifier);
                localStorage.setItem('spotify_code_verifier', codeVerifier);
                const scope = 'user-read-private user-read-email';
                const authUrl = `https://accounts.spotify.com/authorize?response_type=code&client_id=${spotifyClientId}&scope=${encodeURIComponent(scope)}&redirect_uri=${encodeURIComponent(spotifyRedirectUri)}&code_challenge_method=S256&code_challenge=${codeChallenge}`;
                window.location.href = authUrl;
            }
        }
        window.onload = function() {
            spotifyAccessToken = localStorage.getItem('spotify_access_token');
            const urlParams = new URLSearchParams(window.location.search);
            let code = urlParams.get('code');
            if (code) {
                handleSpotifyAuth();
            } else if (spotifyAccessToken) {
                console.log("Spotify token found in local storage.");
            }
        };
        const promptInput = document.getElementById('promptInput');
        const recommendBtn = document.getElementById('recommendBtn');
        const loadingIndicator = document.getElementById('loadingIndicator');
        const recommendationResult = document.getElementById('recommendationResult');
        const songTitle = document.getElementById('songTitle');
        const songDescription = document.getElementById('songDescription');
        const songLink = document.getElementById('songLink');
        const errorAlert = document.getElementById('errorAlert');
        const messageBox = document.getElementById('messageBox');
        const messageContent = document.getElementById('messageContent');
        const closeMessageBtn = document.getElementById('closeMessageBtn');
        const debugOutput = document.getElementById('debug-output');
        const getAnotherBtn = document.getElementById('getAnotherBtn');
        const nextRecommendationBtn = document.getElementById('nextRecommendationBtn');
        const previousRecommendations = document.getElementById('previousRecommendations');
        const previousList = document.getElementById('previousList');
        let chatHistory = [];
        const mySongData = [{
            title: "Modern Art",
            artist: "Joseph Schwartz",
            artistId: "1i0YtjdzwndXd3oQqiiLoT",
            releaseYear: "2025",
            description: "a collection of songs about the creator experience."
        }, {
            title: "Treadmill of hope",
            artist: "Joseph Schwartz",
            artistId: "1i0YtjdzwndXd3oQqiiLoT",
            releaseYear: "2025",
            description: "Pop with a rock edge, about the daily experiences of emerging artists and creators."
        }, {
            title: "Poison Darts",
            artist: "Joseph Schwartz",
            artistId: "1i0YtjdzwndXd3oQqiiLoT",
            releaseYear: "2025",
            description: "Focuses on random online negativity and chasing likes. Relatable to people on social media."
        }, {
            title: "What is art?",
            artist: "Joseph Schwartz",
            artistId: "1i0YtjdzwndXd3oQqiiLoT",
            releaseYear: "2025",
            description: "A reaction to anti-AI sentiment online, arguing that art should be judged on its own merits, not its creation method."
        }, {
            title: "Best of eight",
            artist: "Joseph Schwartz",
            artistId: "1i0YtjdzwndXd3oQqiiLoT",
            releaseYear: "2025",
            description: "Self-referential song about an AI-assisted creation process."
        }, {
            title: "Overnight success",
            artist: "Joseph Schwartz",
            artistId: "1i0YtjdzwndXd3oQqiiLoT",
            releaseYear: "2025",
            description: "Originally about the virtues of 'Patience + Righteousness,' now a song on the topic of patience and principles."
        }, {
            title: "No going back",
            artist: "Joseph Schwartz",
            artistId: "1i0YtjdzwndXd3oQqiiLoT",
            releaseYear: "2025",
            description: "Sane, practical view, about how evil needs misguided commitment, fear, lies, and greed."
        }, {
            title: "Gaslighting",
            artist: "Joseph Schwartz",
            artistId: "1i0YtjdzwndXd3oQqiiLoT",
            releaseYear: "2025",
            description: "Reflects anger and despair at political division, but with a hopeful tone."
        }, {
            title: "We're All Screwed",
            artist: "Joseph Schwartz",
            artistId: "1i0YtjdzwndXd3oQqiiLoT",
            releaseYear: "2025",
            description: "Expression of anger and despair at political division."
        }, {
            title: "Better Off",
            artist: "Joseph Schwartz",
            artistId: "1i0YtjdzwndXd3oQqiiLoT",
            releaseYear: "2025",
            description: "Satirical critique of Trump and Musk, exploring 'daddy issues.'"
        }, {
            title: "Rise Above the Rage",
            artist: "Joseph Schwartz",
            artistId: "1i0YtjdzwndXd3oQqiiLoT",
            releaseYear: "2024",
            description: "A pre-election call for unity."
        }, {
            title: "What Happened to Us?",
            artist: "Joseph Schwartz",
            artistId: "1i0YtjdzwndXd3oQqiiLoT",
            releaseYear: "2024",
            description: "A lament for broken relationships and societal divisions."
        }, {
            title: "Truth is Dead",
            artist: "Joseph Schwartz",
            artistId: "1i0YtjdzwndXd3oQqiiLoT",
            releaseYear: "2025",
            description: "Reflects disillusionment and the loss of truth."
        }, {
            title: "Screaming into the Abyss",
            artist: "Joseph Schwartz",
            artistId: "1i0YtjdzwndXd3oQqiiLoT",
            releaseYear: "2024",
            description: "Collection of political songs."
        }, {
            title: "Anger is all that matters",
            artist: "Joseph Schwartz",
            artistId: "1i0YtjdzwndXd3oQqiiLoT",
            releaseYear: "2024",
            description: "Two distinct voices about the self-destructive anger of the left and right."
        }, {
            title: "The Aftermath",
            artist: "Joseph Schwartz",
            artistId: "1i0YtjdzwndXd3oQqiiLoT",
            releaseYear: "2024",
            description: "Defiant anti-Trump song, reminiscent of Amy Lee."
        }, {
            title: "Pop Serenity Prayer",
            artist: "Joseph Schwartz",
            artistId: "1i0YtjdzwndXd3oQqiiLoT",
            releaseYear: "2024",
            description: "An inspiring pop interpretation of the Serenity Prayer."
        }, {
            title: "Battle against false prophets",
            artist: "Joseph Schwartz",
            artistId: "1i0YtjdzwndXd3oQqiiLoT",
            releaseYear: "2024",
            description: "Christian Rock song about fighting against Trump."
        }, {
            title: "The future",
            artist: "Joseph Schwartz",
            artistId: "1i0YtjdzwndXd3oQqiiLoT",
            releaseYear: "2024",
            description: "Pink Floyd/Alan Parsons feel, about the feelings people have about the future."
        }, {
            title: "The ballad of Donald",
            artist: "Joseph Schwartz",
            artistId: "1i0YtjdzwndXd3oQqiiLoT",
            releaseYear: "2024",
            description: "Traditional political folk song about Trump."
        }, {
            title: "J’adore manger a Gascogne",
            artist: "Joseph Schwartz",
            artistId: "1i0YtjdzwndXd3oQqiiLoT",
            releaseYear: "2025",
            description: "Happy, humorous song about food, inspired by a culinary tour in France."
        }, {
            title: "Searching for Purpose",
            artist: "Joseph Schwartz",
            artistId: "1i0YtjdzwndXd3oQqiiLoT",
            releaseYear: "2024",
            description: "Country song built from a single hook."
        }, {
            title: "Perspective",
            artist: "Joseph Schwartz",
            artistId: "1i0YtjdzwndXd3oQqiiLoT",
            releaseYear: "2024",
            description: "Pop Country, an uplifting song about overcoming fear."
        }, {
            title: "Songs That Need To Be Released",
            artist: "Joseph Schwartz",
            artistId: "1i0YtjdzwndXd3oQqiiLoT",
            releaseYear: "2025",
            description: "Wildly diverse songs."
        }, {
            title: "Ezekiel 23:20",
            artist: "Joseph Schwartz",
            artistId: "1i0YtjdzwndXd3oQqiiLoT",
            releaseYear: "2025",
            description: "A forceful response to book burning, quoting a biblical verse."
        }, {
            title: "Just Be Nice!",
            artist: "Joseph Schwartz",
            artistId: "1i0YtjdzwndXd3oQqiiLoT",
            releaseYear: "2025",
            description: "High-energy dance song with a forceful call for kindness."
        }, {
            title: "Changing my view",
            artist: "Joseph Schwartz",
            artistId: "1i0YtjdzwndXd3oQqiiLoT",
            releaseYear: "2025",
            description: "Song about an alternative perspective."
        }, {
            title: "The Raven",
            artist: "Joseph Schwartz",
            artistId: "1i0YtjdzwndXd3oQqiiLoT",
            releaseYear: "2025",
            description: "Alt-metal adaptation of Poe's poem."
        }, {
            title: "Humility",
            artist: "Joseph Schwartz",
            artistId: "1i0YtjdzwndXd3oQqiiLoT",
            releaseYear: "2025",
            description: "Explores the virtue of humility, aligned with Montaigne's writings."
        }, {
            title: "Perfect Being",
            artist: "Joseph Schwartz",
            artistId: "1i0YtjdzwndXd3oQqiiLoT",
            releaseYear: "2025",
            description: "Explores loneliness from a vampiress's perspective."
        }, {
            title: "No Win",
            artist: "Joseph Schwartz",
            artistId: "1i0YtjdzwndXd3oQqiiLoT",
            releaseYear: "2025",
            description: "Expresses the feeling of being trapped."
        }, {
            title: "Hold it back",
            artist: "Joseph Schwartz",
            artistId: "1i0YtjdzwndXd3oQqiiLoT",
            releaseYear: "2025",
            description: "Silly song."
        }, {
            title: "Caca vs. Me",
            artist: "Joseph Schwartz",
            artistId: "1i0YtjdzwndXd3oQqiiLoT",
            releaseYear: "2025",
            description: "Silly song about stomach issues on vacation."
        }, {
            title: "My Angel",
            artist: "Joseph Schwartz",
            artistId: "1i0YtjdzwndXd3oQqiiLoT",
            releaseYear: "2025",
            description: "Most streamed song, lyrics by Herman Bean."
        }, {
            title: "Beauty Queen",
            artist: "Joseph Schwartz",
            artistId: "1i0YtjdzwndXd3oQqiiLoT",
            releaseYear: "2025",
            description: "Beauty Queen (Country and Alternative versions)"
        }, {
            title: "Movin’ On",
            artist: "Joseph Schwartz",
            artistId: "1i0YtjdzwndXd3oQqiiLoT",
            releaseYear: "2025",
            description: "Movin’ On (Country and Rock versions)"
        }, {
            title: "Searching for a star",
            artist: "Joseph Schwartz",
            artistId: "1i0YtjdzwndXd3oQqiiLoT",
            releaseYear: "2025",
            description: "Searching for a star (Rock and Disco versions)"
        }, {
            title: "Herman Bean",
            artist: "Joseph Schwartz",
            artistId: "1i0YtjdzwndXd3oQqiiLoT",
            releaseYear: "2025",
            description: "Captures the story of the lyricist's sister."
        }, {
            title: "Through his eyes",
            artist: "Joseph Schwartz",
            artistId: "1i0YtjdzwndXd3oQqiiLoT",
            releaseYear: "2024",
            description: "The first full album of collaboration with lyricist Herman Bean"
        }, {
            title: "Keep on walking",
            artist: "Joseph Schwartz",
            artistId: "1i0YtjdzwndXd3oQqiiLoT",
            releaseYear: "2024",
            description: "The first full album of collaboration with lyricist Herman Bean"
        }, {
            title: "The time is coming",
            artist: "Joseph Schwartz",
            artistId: "1i0YtjdzwndXd3oQqiiLoT",
            releaseYear: "2024",
            description: "The first full album of collaboration with lyricist Herman Bean"
        }, {
            title: "Child grows",
            artist: "Joseph Schwartz",
            artistId: "1i0YtjdzwndXd3oQqiiLoT",
            releaseYear: "2024",
            description: "The first full album of collaboration with lyricist Herman Bean"
        }, {
            title: "Summertime",
            artist: "Joseph Schwartz",
            artistId: "1i0YtjdzwndXd3oQqiiLoT",
            releaseYear: "2024",
            description: "The first full album of collaboration with lyricist Herman Bean"
        }, {
            title: "Win or lose",
            artist: "Joseph Schwartz",
            artistId: "1i0YtjdzwndXd3oQqiiLoT",
            releaseYear: "2024",
            description: "The first full album of collaboration with lyricist Herman Bean"
        }, {
            title: "That's the way it should be",
            artist: "Joseph Schwartz",
            artistId: "1i0YtjdzwndXd3oQqiiLoT",
            releaseYear: "2024",
            description: "The first full album of collaboration with lyricist Herman Bean"
        }, {
            title: "I'll see you in the heavens tonight",
            artist: "Joseph Schwartz",
            artistId: "1i0YtjdzwndXd3oQqiiLoT",
            releaseYear: "2024",
            description: "The first full album of collaboration with lyricist Herman Bean"
        }, {
            title: "Fighter!",
            artist: "Joseph Schwartz",
            artistId: "1i0YtjdzwndXd3oQqiiLoT",
            releaseYear: "2024",
            description: "The first full album of collaboration with lyricist Herman Bean"
        }, {
            title: "Wings of Faith",
            artist: "Joseph Schwartz",
            artistId: "1i0YtjdzwndXd3oQqiiLoT",
            releaseYear: "2024",
            description: "Captures the essence of a quote by Steven Weinberg about faith."
        }, {
            title: "Kindness",
            artist: "Joseph Schwartz",
            artistId: "1i0YtjdzwndXd3oQqiiLoT",
            releaseYear: "2024",
            description: "Storytelling singer-songwriter song about the personal benefits of kindness."
        }, {
            title: "Dance Like the Man",
            artist: "Joseph Schwartz",
            artistId: "1i0YtjdzwndXd3oQqiiLoT",
            releaseYear: "2024",
            description: "all versions: A single song with different genre arrangements (Americana, Pop Country, Deep House) with lyrics as a rant about Trump sycophants."
        }, {
            title: "Sloth",
            artist: "Joseph Schwartz",
            artistId: "1i0YtjdzwndXd3oQqiiLoT",
            releaseYear: "2024",
            description: "REM-like jangle pop."
        }, {
            title: "Pride",
            artist: "Joseph Schwartz",
            artistId: "1i0YtjdzwndXd3oQqiiLoT",
            releaseYear: "2024",
            description: "Power pop/rock."
        }, {
            title: "Greed",
            artist: "Joseph Schwartz",
            artistId: "1i0YtjdzwndXd3oQqiiLoT",
            releaseYear: "2024",
            description: "Alt-rock."
        }, {
            title: "Lust",
            artist: "Joseph Schwartz",
            artistId: "1i0YtjdzwndXd3oQqiiLoT",
            releaseYear: "2024",
            description: "Lust, Vanity, Gluttony, Wrath."
        }, {
            title: "Vanity",
            artist: "Joseph Schwartz",
            artistId: "1i0YtjdzwndXd3oQqiiLoT",
            releaseYear: "2024",
            description: "Lust, Vanity, Gluttony, Wrath."
        }, {
            title: "Gluttony",
            artist: "Joseph Schwartz",
            artistId: "1i0YtjdzwndXd3oQqiiLoT",
            releaseYear: "2024",
            description: "Lust, Vanity, Gluttony, Wrath."
        }, {
            title: "Wrath",
            artist: "Joseph Schwartz",
            artistId: "1i0YtjdzwndXd3oQqiiLoT",
            releaseYear: "2024",
            description: "Lust, Vanity, Gluttony, Wrath."
        }, {
            title: "Tangled Words",
            artist: "Joseph Schwartz",
            artistId: "1i0YtjdzwndXd3oQqiiLoT",
            releaseYear: "2024",
            description: "Critiques the language of the Second Amendment."
        }, {
            title: "The Hardest Truth of All",
            artist: "Joseph Schwartz",
            artistId: "1i0YtjdzwndXd3oQqiiLoT",
            releaseYear: "2024",
            description: "Captures the feeling of a MAGA supporter being misled."
        }, {
            title: "Woken from a Lie",
            artist: "Joseph Schwartz",
            artistId: "1i0YtjdzwndXd3oQqiiLoT",
            releaseYear: "2025",
            description: "Similar to 'The Hardest Truth of All.'"
        }, {
            title: "Herman Bean Country and Variants",
            artist: "Joseph Schwartz",
            artistId: "1i0YtjdzwndXd3oQqiiLoT",
            releaseYear: "2024",
            description: "Showcases the versatility of Herman Bean's lyrics by presenting different musical interpretations of the same lyrics."
        }, {
            title: "My Angel (Country Version)",
            artist: "Joseph Schwartz",
            artistId: "1i0YtjdzwndXd3oQqiiLoT",
            releaseYear: "2024",
            description: "My Angel (Country Version)"
        }, {
            title: "My Angel (Pop Version)",
            artist: "Joseph Schwartz",
            artistId: "1i0YtjdzwndXd3oQqiiLoT",
            releaseYear: "2024",
            description: "My Angel (Pop Version)"
        }, {
            title: "Beauty Queen (Country Version)",
            artist: "Joseph Schwartz",
            artistId: "1i0YtjdzwndXd3oQqiiLoT",
            releaseYear: "2024",
            description: "Beauty Queen (Country Version)"
        }, {
            title: "Beauty Queen (Alternative Version)",
            artist: "Joseph Schwartz",
            artistId: "1i0YtjdzwndXd3oQqiiLoT",
            releaseYear: "2024",
            description: "Beauty Queen (Alternative Version)"
        }, {
            title: "Movin’ On (Country Version)",
            artist: "Joseph Schwartz",
            artistId: "1i0YtjdzwndXd3oQqiiLoT",
            releaseYear: "2024",
            description: "Movin’ On (Country and Rock versions)"
        }, {
            title: "Movin’ On (Rock Version)",
            artist: "Joseph Schwartz",
            artistId: "1i0YtjdzwndXd3oQqiiLoT",
            releaseYear: "2024",
            description: "Movin’ On (Rock Version)"
        }, {
            title: "Searching for a star (Rock Version)",
            artist: "Joseph Schwartz",
            artistId: "1i0YtjdzwndXd3oQqiiLoT",
            releaseYear: "2024",
            description: "Searching for a star (Rock Version)"
        }, {
            title: "Searching for a star (Disco Version)",
            artist: "Joseph Schwartz",
            artistId: "1i0YtjdzwndXd3oQqiiLoT",
            releaseYear: "2024",
            description: "Searching for a star (Disco Version)"
        }, {
            title: "Relax",
            artist: "Icebox Pi",
            artistId: "4lwHc4bYmRIJcaTOLqFxBy",
            releaseYear: "2024",
            description: "An ambient drone album that feels like a float around the universe."
        }, {
            title: "Cosmic Window Shopping",
            artist: "Icebox Pi",
            artistId: "4lwHc4bYmRIJcaTOLqFxBy",
            releaseYear: "2024",
            description: "An ambient drone album that feels like a float around the universe."
        }, {
            title: "Peaceful Journey",
            artist: "Icebox Pi",
            artistId: "4lwHc4bYmRIJcaTOLqFxBy",
            releaseYear: "2024",
            description: "A new-age album."
        }];

        const artistIds = {
            "Joseph Schwartz": "1i0YtjdzwndXd3oQqiiLoT",
            "Icebox Pi": "4lwHc4bYmRIJcaTOLqFxBy"
        };
        async function searchSpotify(query) {
            if (!spotifyAccessToken) {
                return null;
            }
            try {
                const response = await fetch(`https://api.spotify.com/v1/search?q=${encodeURIComponent(query)}&type=track&limit=1`, {
                    headers: {
                        'Authorization': `Bearer ${spotifyAccessToken}`
                    }
                });
                if (response.status === 401) {
                    localStorage.removeItem('spotify_access_token');
                    return null;
                }
                if (!response.ok) {
                    throw new Error(`Spotify API error: ${response.status} ${response.statusText}`);
                }
                const data = await response.json();
                const track = data.tracks.items[0];
                if (track) {
                    return track.external_urls.spotify;
                } else {
                    return null;
                }
            } catch (error) {
                console.error("Spotify API Search Error:", error);
                return null;
            }
        }
        async function searchSpotifyById(songName, artistId) {
            if (!spotifyAccessToken) {
                return null;
            }
            try {
                const query = `track:"${songName}" artist:${artistId}`;
                const response = await fetch(`https://api.spotify.com/v1/search?q=${encodeURIComponent(query)}&type=track&limit=1`, {
                    headers: {
                        'Authorization': `Bearer ${spotifyAccessToken}`
                    }
                });
                if (response.status === 401) {
                    localStorage.removeItem('spotify_access_token');
                    return null;
                }
                if (!response.ok) {
                    throw new Error(`Spotify API error: ${response.status} ${response.statusText}`);
                }
                const data = await response.json();
                const track = data.tracks.items[0];
                if (track && track.artists.some(artist => artist.id === artistId)) {
                    return track.external_urls.spotify;
                } else {
                    return null;
                }
            } catch (error) {
                console.error("Spotify API Search Error:", error);
                return null;
            }
        }
        function showMessage(message) {
            messageContent.textContent = message;
            messageBox.classList.remove('hidden');
        }
        let currentPrompt = '';
        let currentRecommendations = [];
        recommendBtn.addEventListener('click', async () => {
            currentPrompt = promptInput.value.trim();
            if (currentPrompt === "") {
                showMessage("Please enter a topic, mood, or genre to get a recommendation.");
                return;
            }
            currentRecommendations = [];
            previousList.innerHTML = '';
            await getRecommendation();
            previousRecommendations.classList.remove('hidden');
        });
        getAnotherBtn.addEventListener('click', async () => {
            await getRecommendation(true);
        });
        async function getRecommendation(isAnother = false) {
            loadingIndicator.classList.remove('hidden');
            recommendationResult.classList.add('hidden');
            errorAlert.classList.add('hidden');
            recommendBtn.disabled = true;
            nextRecommendationBtn.classList.add('hidden');
            if (!spotifyAccessToken) {
                showMessage("To get a working Spotify link, please log in.");
                closeMessageBtn.onclick = () => {
                    messageBox.classList.add('hidden');
                    handleSpotifyAuth();
                };
                return;
            }
            const systemPrompt = `You are a music recommendation AI. Your goal is to recommend a single song to the user based on their input.
            
            When recommending a song, you must first search the provided music catalog to see if any song is an excellent match for the user's request. If a song from the provided catalog is a perfect match, you must recommend it. If not, you may recommend a well-known, popular song from another artist that fits the request.
            
            The user's music catalog is as follows:
            ${JSON.stringify(mySongData, null, 2)}
            
            Your response should be a single, concise paragraph. Start with "A perfect song for your request is '[Song Title]' by [Artist Name].". The rest of the paragraph should briefly explain why you chose the song. If the song is from the provided catalog, use details from the catalog. Do not use markdown formatting.
            
            Example output:
            "A perfect song for your request is 'Rise Above the Rage' by Joseph Schwartz. This song is a pre-election call for unity and a great fit for a message of hope."`;
            let userQuery = `Recommend a song based on this: "${currentPrompt}"`;
            if (isAnother && currentRecommendations.length > 0) {
                const excludedSongs = currentRecommendations.map(rec => rec.title);
                userQuery += ` Do not recommend any of the following songs: ${excludedSongs.join(', ')}.`;
            }
            try {
                const response = await fetch(googleApiUrl, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        contents: [{
                            parts: [{
                                text: userQuery
                            }]
                        }],
                        systemInstruction: {
                            parts: [{
                                text: systemPrompt
                            }]
                        }
                    })
                });
                if (!response.ok) {
                    throw new Error(`Google API error: ${response.status} ${response.statusText}`);
                }
                const result = await response.json();
                const rawResponse = result.candidates?.[0]?.content?.parts?.[0]?.text || 'No recommendation found.';
                const debugInfo = `Beginning recommendation process...
User Query to AI: "${currentPrompt}"
AI Raw Response: "${rawResponse}"`;
                debugOutput.textContent = debugInfo;
                const match = rawResponse.match(/"([^"]+)" by (.+?)(?:\s|$)/);
                if (match) {
                    const songName = match[1];
                    const artistName = match[2].trim().replace(/\.$/, '');
                    const description = rawResponse.replace(`A perfect song for your request is '${songName}' by ${artistName}.`, '').trim();
                    songTitle.textContent = `"${songName}" by ${artistName}`;
                    songDescription.textContent = description;
                    let spotifyLink = null;
                    const songInCatalog = mySongData.find(s => s.title === songName && s.artist === artistName);
                    if (songInCatalog) {
                        const artistId = artistIds[artistName];
                        if (artistId) {
                            spotifyLink = await searchSpotifyById(songName, artistId);
                            debugOutput.textContent += `\nParsed Song Name: "${songName}"\nParsed Artist Name: "${artistName}"\nFound song in catalog. Artist ID: ${artistId}\nSpotify Link Found: ${spotifyLink}`;
                        }
                    } else {
                        spotifyLink = await searchSpotify(`${songName} ${artistName}`);
                        debugOutput.textContent += `\nParsed Song Name: "${songName}"\nParsed Artist Name: "${artistName}"\nSong not in catalog. General search used.\nSpotify Link Found: ${spotifyLink}`;
                    }
                    if (spotifyLink) {
                        songLink.href = spotifyLink;
                        songLink.textContent = "Listen on Spotify";
                        songLink.classList.remove('spotify-link-disabled');
                    } else {
                        songLink.href = "javascript:void(0)";
                        songLink.textContent = "Link not found on Spotify.";
                        songLink.classList.add('spotify-link-disabled');
                    }
                    recommendationResult.classList.remove('hidden');
                    nextRecommendationBtn.classList.remove('hidden');
                    const newRec = {
                        title: songName,
                        artist: artistName,
                        link: spotifyLink
                    };
                    currentRecommendations.push(newRec);
                    const recElement = document.createElement('div');
                    recElement.innerHTML = `<h4 class="font-medium text-gray-700">"${songName}" by ${artistName}</h4>`;
                    if (spotifyLink) {
                        recElement.innerHTML += `<a href="${spotifyLink}" target="_blank" class="text-xs text-indigo-500 hover:underline">Listen on Spotify</a>`;
                    } else {
                        recElement.innerHTML += `<span class="text-xs text-gray-500">Link not found on Spotify.</span>`;
                    }
                    if (isAnother) {
                        previousList.appendChild(recElement);
                    } else {
                        previousList.innerHTML = '';
                        previousList.appendChild(recElement);
                    }
                } else {
                    throw new Error('Could not parse song title and artist from AI response.');
                }
            } catch (error) {
                console.error("Fetch error:", error);
                errorAlert.textContent = `An error occurred: ${error.message}`;
                errorAlert.classList.remove('hidden');
            } finally {
                loadingIndicator.classList.add('hidden');
                recommendBtn.disabled = false;
            }
        }
        promptInput.addEventListener('keypress', (event) => {
            if (event.key === 'Enter') {
                recommendBtn.click();
            }
        });
        closeMessageBtn.addEventListener('click', () => {
            messageBox.classList.add('hidden');
        });
    </script>
</body>

</html>
